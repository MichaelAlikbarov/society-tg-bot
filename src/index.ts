import { Telegraf } from 'telegraf';
import express from 'express';
import * as dotenv from 'dotenv';
import { askGPT } from './askGPT';

dotenv.config();

const bot = new Telegraf(process.env.BOT_TOKEN!);
const app = express();
const PORT = process.env.PORT || 3000;
const WEBHOOK_URL = 'https://society-tg-bot.onrender.com';

// Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ webhook
bot.telegram.setWebhook(`${WEBHOOK_URL}/bot${process.env.BOT_TOKEN}`);

// ÐŸÑ€Ð¸Ð½Ð¸Ð¼Ð°ÐµÐ¼ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ñ Ð¾Ñ‚ Telegram Ñ‡ÐµÑ€ÐµÐ· Ð²ÐµÐ±Ñ…ÑƒÐº
app.use(express.json());
app.post(`/bot${process.env.BOT_TOKEN}`, (req, res) => {
  bot.handleUpdate(req.body, res);
});

// Ð Ð¾ÑƒÑ‚ Ð´Ð»Ñ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ¸
app.get('/', (_req, res) => {
  res.send('Ð‘Ð¾Ñ‚ Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½ Ð¸ Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚ âœ…');
});

// ÐžÐ±Ñ€Ð°Ð±Ð°Ñ‚Ñ‹Ð²Ð°ÐµÐ¼ ÐºÐ¾Ð¼Ð°Ð½Ð´Ñ‹
bot.start((ctx) => {
  ctx.reply('ðŸ‘‹ ÐŸÑ€Ð¸Ð²ÐµÑ‚! Ð¯ Ð¿Ð¾Ð¼Ð¾Ñ‰Ð½Ð¸Ðº Ð¿Ð¾ Ð¾Ð±Ñ‰ÐµÑÑ‚Ð²Ð¾Ð·Ð½Ð°Ð½Ð¸ÑŽ.\nÐ’Ñ‹Ð±ÐµÑ€Ð¸ Ñ‚ÐµÐ¼Ñƒ Ð¸Ð»Ð¸ Ð·Ð°Ð´Ð°Ð¹ Ð²Ð¾Ð¿Ñ€Ð¾Ñ.');
});

bot.on('text', async (ctx) => {
  const question = ctx.message.text;
  ctx.reply('ðŸ¤” Ð”ÑƒÐ¼Ð°ÑŽ...');
  try {
    const answer = await askGPT(question);
    ctx.reply(answer);
  } catch (err) {
    console.error(err);
    ctx.reply('âŒ ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ð¾Ð±Ñ€Ð°Ñ‰ÐµÐ½Ð¸Ð¸ Ðº GPT. ÐŸÐ¾Ð¿Ñ€Ð¾Ð±ÑƒÐ¹ Ð¿Ð¾Ð·Ð¶Ðµ.');
  }
});

// Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Express-ÑÐµÑ€Ð²ÐµÑ€
app.listen(PORT, () => {
  console.log(`ðŸš€ Ð¡ÐµÑ€Ð²ÐµÑ€ ÑÐ»ÑƒÑˆÐ°ÐµÑ‚ Ð¿Ð¾Ñ€Ñ‚ ${PORT}`);
  console.log('ðŸ¤– Ð‘Ð¾Ñ‚ Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚ Ñ‡ÐµÑ€ÐµÐ· webhook');
});

// Ð“Ñ€ÐµÐ¹ÑÑ„ÑƒÐ» ÑˆÑƒÑ‚Ð´Ð°ÑƒÐ½
process.once('SIGINT', () => bot.stop('SIGINT'));
process.once('SIGTERM', () => bot.stop('SIGTERM'));